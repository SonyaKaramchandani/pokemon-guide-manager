# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

pool: "default"

variables:
  buildConfiguration: "Release"

steps:
  - task: UseDotNet@2
    displayName: "Install .net core 3.x"
    inputs:
      packageType: sdk
      version: "3.x"
      installationPath: $(Agent.ToolsDirectory)/dotnet
      performMultiLevelLookup: true
  - task: DotNetCoreCLI@2
    inputs:
      command: "publish"
      projects: "Biod.Insights.Api/Biod.Insights.Api.csproj"
      arguments: "--configuration $(buildConfiguration) --output $(build.artifactstagingdirectory)"
      publishWebProjects: false
      zipAfterPublish: true
  - task: NodeTool@0
    inputs:
      versionSpec: "10.x"
    displayName: "Install Node.js"
  - script: |
      yarn
    displayName: "npm install"
    workingDirectory: "biod.insights.app"
  - script: |
      yarn build
    displayName: "npm build"
    workingDirectory: "biod.insights.app"
  - task: ArchiveFiles@2
    inputs:
      includeRootFolder: false
      rootFolderOrFile: "biod.insights.app/build"
      archiveFile: "$(build.artifactstagingdirectory)/biod.insights.app.zip"
  - script: |
      yarn test:ci
    displayName: "npm run test"
    workingDirectory: "biod.insights.app"
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "biod.insights.app/junit.xml"
      testRunTitle: "Insights App CI Tests $(Agent.OS)"
    displayName: "Publish Insights App test results"
    condition: succeededOrFailed()
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(build.artifactstagingdirectory)
      artifactName: drop
