@using Biod.Zebra.Library.Infrastructures

<script>
    require(["esri/map", "esri/layers/VectorTileLayer",], function (Map, VectorTileLayer) {
            //=====Map initialization START=====
            var bm = new VectorTileLayer('@Url.Content("~/Areas/DashboardPage/Content/root.json")');
            var currentZoom = 2;

            //var ref = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json");
            Dashboard.Prop.map = new Map("map-div", {
                //basemap: "gray-vector",
                center: [-46.807, 32.553],
                zoom: currentZoom,
                minZoom: 2,
                //showInfoWindowOnClick: false,
                showLabels: true //very important that this must be set to true!
            });

            //var evtHndler = Dashboard.Prop.map.on("load", function (results) {
            //    setTimeout(function () {
            //        Dashboard.Func.initEventDetailMap();
            //        Dashboard.Func.initEventDetailPolygon();
            //        Dashboard.Func.initEventDetailPoint();
            //    }, 4000);
            //    evtHndler.remove(); //after the event handler gets fired, remove it
            //});

            Dashboard.Prop.map.addLayers([bm]);

            Dashboard.Func.initCountryPolygon();
            Dashboard.Func.initCountryPoint();
            Dashboard.Func.initCityPoint();

            //hide the popup if its outside the map's extent
            Dashboard.Prop.map.on("pan-end", function (evt) {
                window.gtagh('@Html.Raw(Constants.GoogleAnalytics.Action.PAN_MAP)', '@Html.Raw(Constants.GoogleAnalytics.Category.MAP)');

                if (Dashboard.Prop.map.infoWindow.isShowing) {
                    var xMin = Dashboard.Prop.map.geographicExtent.xmin;
                    var xMax = Dashboard.Prop.map.geographicExtent.xmax;
                    var x = Dashboard.Prop.map.infoWindow.location.x;

                    if (xMin > x) {
                        var nX = x + 360;
                        if (xMax >= nX && xMin <= nX) {
                            Dashboard.Prop.map.infoWindow.location.x = nX;
                            Dashboard.Prop.map.infoWindow.reposition();
                        }
                    }
                    else if (xMax < x) {
                        var nX = x - 360;
                        if (xMax >= nX && xMin <= nX) {
                            Dashboard.Prop.map.infoWindow.location.x = nX;
                            Dashboard.Prop.map.infoWindow.reposition();
                        }
                    }
                }

                startRepositionLoop();
            });

            var loopEvt = null;
            function startRepositionLoop() {
                endRepositionLoop();
                loopEvt = setInterval(function () {
                    if (Dashboard.Prop.map.infoWindow.isShowing) {
                        Dashboard.Prop.map.infoWindow.reposition();
                    }
                    else {
                        endRepositionLoop();
                    }
                }, 5000);
            }

            function endRepositionLoop() {
                clearInterval(loopEvt)
            }

            Dashboard.Prop.map.on("zoom-end", function (e) {
                if (currentZoom < e.level) {
                    window.gtagh(
                        '@Html.Raw(Constants.GoogleAnalytics.Action.CLICK_ZOOM_IN)',
                        '@Html.Raw(Constants.GoogleAnalytics.Category.MAP)',
                        'Zoom in on map',
                        e.level);
                } else if (currentZoom > e.level) {
                    window.gtagh(
                        '@Html.Raw(Constants.GoogleAnalytics.Action.CLICK_ZOOM_OUT)',
                        '@Html.Raw(Constants.GoogleAnalytics.Category.MAP)',
                        'Zoom out on map',
                        e.level);
                }
                currentZoom = e.level;
            });

            //proj4("EPSG:4326","EPSG:3857",[0,0]);//wgs84 to web mercator
        }
    );
</script>